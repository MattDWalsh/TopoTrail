{% extends 'base.html' %}
{% block title_post %}: {{ trail.name }}
{% endblock %}
{% block content %}
{% if trail.mesh and trail.texture_trail %}
<div id="threejs" style="width:100%; height: 50vh; background-color: #263238; color:white;"></div>
{% endif %}
<header>
    <div>
        <h1>[[ trailAssets.name ]]</h1>
        <p>
            added by <a href="#modal-user-trails" class="modal-trigger">[[ trailAssets.upload_user ]]</a> on [[ new Date(trailAssets.timestamp).toLocaleDateString() ]] at [[ new Date(trailAssets.timestamp).toLocaleTimeString() ]]

            <i v-if="trailAssets.share == 'private'" class="material-icons" :title="trailAssets.share">lock</i>
            <i v-if="trailAssets.share == 'public'"  class="material-icons" :title="trailAssets.share">public</i>
            <i v-if="trailAssets.share == 'link'"  class="material-icons" :title="trailAssets.share">share</i>

        </p>
    </div>
</header>
<section>
    <div>
        <p>[[ trailAssets.desc ]]</p>
        <a href="#" @click="testToggle">test toggle</a>
        <a href="#" @click="initModalTest">init modal test</a>
        <div id="trail-photos-container" v-if="trailPhotos.length">
            <h4>
                Photos
            </h4>
            <div id="trail-photos" ref="trailPhotos">
                <figure v-for="photo in trailPhotos" :key="photo.id">
                    <a :href="photo.photoHREF" class="modal-trigger">
                        <img :src="photo.thumb" :alt="photo.caption" class="modal-thumb">
                    </a>
                    <div :id="photo.photoID" class="modal">
                        <div class="modal-content">
                            <img :src="photo.url" :alt="photo.caption" class="inside-modal">
                            <p>[[ photo.caption ]]</p>
                            <p><em>Uploaded by [[ photo.user ]] on [[ new Date(photo.timestamp).toLocaleDateString() ]] at [[ new Date(photo.timestamp).toLocaleTimeString() ]].</em></p>
                        </div>
                        <!-- <div class="modal-footer">
                            [[ photo.id ]]
                            <a href="#!" class="modal-close waves-effect waves-green btn-flat">Agree</a>
                        </div> -->
                    </div>
                </figure>
            </div>
        </div>
    </div>

    <aside>
        {% if trail.upload_user == request.user %}
        <a class="modal-trigger" href="#modal-add-photos">Add Photos</a>
        {% endif %}
        
        <h5>Center point:</h5>
        <p>{{ trail.center_lat }}, {{ trail.center_lon }}</p>

        <h5>Edges of trail:</h5>
        <p><strong>N:</strong> {{ trail.max_lat }}, <strong>E:</strong> {{ trail.max_lon }}, <strong>S:</strong> {{ trail.min_lat }}, <strong>W:</strong> {{ trail.min_lon }}</p>

        <h5>Status:</h5>
        <h6>Overall status:</h6>
        <p>{{ trail.status_overall }}</p>
        <ul>
            <li>Trail parsed: {{ trail.status_parsed }}</li>
            <li>Waypoints built: {{ trail.status_waypoints }}</li>
            <li>Heightmap retrieved: {{ trail.status_heightmap }}</li>
            <li>Mesh generated: {{ trail.status_mesh }}</li>
            <li>Trail texture generated: {{ trail.status_texture_trail }}</li>
            <li>Satellite texture retrieved: {{ trail.status_texture_satellite }}</li>
        </ul>
        {% if True == False %}
        <h5>Waypoints:</h5>
        <ul>
            {% for waypoint in trail_waypoints %}
            <li>{{ waypoint.lat }}, {{ waypoint.lon }}{% if waypoint.notes %}<p>{{ waypoint.notes }}</p>{% endif %}{% if request.user == trail.upload_user %} <button>future edit button</button>{% endif %}</li>
            {% endfor %}
        </ul>
        {% endif %}

        {% if request.user == trail.upload_user %}
        <h5>Edit description:</h5>
        <form action="{% url 'trails:edit_trail' trail.slug %}" method="POST" enctype="multipart/form-data">
            {% csrf_token %}
            <input type="textarea" name="desc" value="{{ trail.desc }}">
            <button type="submit">Save Changes</button>
        </form>
        <form action="{% url 'trails:delete_trail' trail.slug %}" method="post">
            {% csrf_token %}
            <button type="submit">Delete Trail</button>
        </form>
        {% endif %}
    </aside>
</section>

{% if trail.mesh and trail.texture_trail %}
{% load static %}
<script type="importmap">
    {
        "imports": {
            "three": "{% static 'three.module.js' %}",
            "obj": "{% static 'OBJLoader.js' %}",
            "orbit": "{% static 'OrbitControls.js' %}"
        }
    }
</script>
<script type="module" defer>
    import * as THREE from 'three';
    import { OBJLoader } from 'obj';
    import { OrbitControls } from 'orbit';
    let camera, controls, scene, renderer;
    let mesh;
    
    var OBJFile = app.trailAssets.mesh;
    var JPGFile = app.trailAssets.texture_trail;
    function loadAssets () {
        var loadedOBJ = new OBJLoader()
        .load(OBJFile, function (object) {
                object.position.y = - 25;
                var texture = new THREE.TextureLoader().load(JPGFile);
                
                object.traverse(function (child) {
                    if (child instanceof THREE.Mesh) {
                        child.material.map = texture;
                    }
                });
                scene.add(object);
            });
    }
    loadAssets();
    init();
    animate();
    const renderElement = document.getElementById("threejs");
    function init() {
        // camera
        const renderElement = document.getElementById("threejs");
        //camera = new THREE.PerspectiveCamera( 70, window.innerWidth / window.innerHeight, 1, 1000 );
        camera = new THREE.PerspectiveCamera( 70, renderElement.offsetWidth / renderElement.offsetHeight, 1, 1000 );
        camera.position.z = 100; // make this dynamic !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
        camera.position.y = renderElement.offsetHeight / 8;
        // scene
        scene = new THREE.Scene();
        //scene.background = "263238"
        // lights
        const ambientLight = new THREE.AmbientLight( 0xcccccc, 0.2 );
        scene.add( ambientLight );
        const pointLight = new THREE.PointLight( 0xffffff, 0.6 );
        camera.add( pointLight );
        scene.add( camera );
        // mesh/texture loaders
        // django method
        //var OBJFile = '{{ trail.mesh.url }}';
        //var JPGFile = '{{ trail.texture_trail.url }}';
        // vue method
        //var OBJFile = app.trailAssets.mesh;
        //var JPGFile = app.trailAssets.texture_trail;
        //new OBJLoader()
        //.load(OBJFile, function (object) {
        //        object.position.y = - 25;
        //        var texture = new THREE.TextureLoader().load(JPGFile);
        //        
        //        object.traverse(function (child) {
        //            if (child instanceof THREE.Mesh) {
        //                child.material.map = texture;
        //            }
        //        });
        //        scene.add(object);
        //    });
        // renderer
        renderer = new THREE.WebGLRenderer( { antialias: true } );
        renderer.setPixelRatio( window.devicePixelRatio );
        renderer.setClearColor (0x263238, 0);
        //const renderElement = document.getElementById("threejs");
        //renderer.setSize( window.innerWidth, window.innerHeight );
        renderer.setSize( renderElement.offsetWidth, renderElement.offsetHeight );
        renderElement.appendChild( renderer.domElement );
        //
        window.addEventListener( 'resize', onWindowResize );
        // controls
        controls = new OrbitControls( camera, renderer.domElement );
        controls.listenToKeyEvents( window );
        controls.enableDamping = true;
        controls.dampingFactor = 0.05;
        controls.maxPolarAngle = Math.PI / 2;
    }
    
    function onWindowResize() {
        //camera.aspect = window.innerWidth / window.innerHeight;
        camera.aspect = renderElement.offsetWidth / renderElement.offsetHeight;
        //camera.position.y = renderElement.offsetHeight / 8;
        camera.updateProjectionMatrix();
        //renderer.setSize( window.innerWidth, window.innerHeight );
        renderer.setSize( renderElement.offsetWidth, renderElement.offsetHeight );
    }
    function animate() {
        if ((JPGFile != app.trailAssets.texture_trail) || (OBJFile != app.trailAssets.mesh)) {
            JPGFile = app.trailAssets.texture_trail
            OBJFile = app.trailAssets.mesh
            loadAssets()
            scene.remove(scene.children[2])
        }
        requestAnimationFrame( animate );
        controls.update();
        renderer.render( scene, camera );
    }
</script>
{% endif %}

{% endblock %}

{% block modals %}
    {% if trail.upload_user == request.user %} 
    <!-- Add Photos Modal -->
    <div id="modal-add-photos" class="modal bottom-sheet">
        <div class="modal-content">
            <h4>Upload photos</h4>
            <div class="file-field input-field">
                <div class="btn">
                    <span>Choose a file...</span>
                    <input type="file" ref="trailphotofile" @change="selectNewTrailPhotos" accept=".jpg,.jpeg,.png,.gif,.webp" multiple>
                    <input type="hidden" value="{{ request.user }}">
                </div>
                <div class="file-path-wrapper">
                    <input class="file-path validate" type="text">
                </div>
            </div>
            <!-- <button v-if="newPhotos.length" @click="uploadNewTrailPhotos">Upload</button> -->
            <div v-if="newPhotos.length">
                <p v-for="newPhoto in newPhotos">
                    [[ newPhoto.name ]] [[ newPhoto.status ]]
                </p>
            </div>
            <!-- <form @submit.prevent="addTrailPhotos">
                <input type="file" @change="uploadFile" multiple>
                <input type="submit" value="send em">
            </form> -->
        </div>
        <!-- <div class="modal-footer">
            <a href="#!" class="modal-close waves-effect waves-green btn-flat">Agree</a>
        </div> -->
    </div>
    {% endif %}
    <!-- User Trails Modal -->
    <div id="modal-user-trails" class="modal bottom-sheet">
        <div class="modal-content">
            <h4>Trails added by [[ trailAssets.upload_user ]]</h4>
            <ul>
                <li v-for="trail in userTrails">
                    <a :href="trail.slug">[[ trail.name ]]</a> - <em>added [[ new Date(trail.timestamp).toLocaleDateString() ]]</em>
                </li>
            </ul>
        </div>
    </div>
{% endblock %}